<!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">       
      <title>SmartSpend Financial Report</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }

          body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;        
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);       
              min-height: 100vh;
              padding: 20px;
          }

          .container {
              max-width: 1200px;
              margin: 0 auto;
              background: white;
              border-radius: 20px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.1);
              overflow: hidden;
          }

          .header {
              background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);       
              color: white;
              padding: 30px;
              text-align: center;
          }

          .header h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
          }

          .header p {
              font-size: 1.2em;
              opacity: 0.9;
          }

          .content {
              padding: 40px;
          }

          .summary-cards {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 20px;
              margin-bottom: 40px;
          }

          .card {
              background: #f8f9fa;
              border-radius: 15px;
              padding: 25px;
              text-align: center;
              border: 2px solid #e9ecef;
              transition: transform 0.3s ease;
          }

          .card:hover {
              transform: translateY(-5px);
          }

          .card h3 {
              color: #495057;
              margin-bottom: 10px;
              font-size: 1.1em;
          }

          .card .amount {
              font-size: 2em;
              font-weight: bold;
              color: #2c3e50;
          }

          .income .amount { color: #27ae60; }
          .expense .amount { color: #e74c3c; }
          .balance .amount { color: #3498db; }

          .charts {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 40px;
              margin-top: 40px;
          }

          .chart-container {
              background: #f8f9fa;
              border-radius: 15px;
              padding: 30px;
          }

          .chart-title {
              text-align: center;
              margin-bottom: 20px;
              font-size: 1.4em;
              color: #2c3e50;
          }

          @media (max-width: 768px) {
              .charts {
                  grid-template-columns: 1fr;
              }
              .header h1 {
                  font-size: 2em;
              }
              .content {
                  padding: 20px;
              }
          }

          .error {
              text-align: center;
              padding: 50px;
              color: #e74c3c;
              font-size: 1.2em;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="header">
              <h1>üìä SmartSpend Report</h1>
              <p id="reportPeriod">Financial Report</p>
          </div>

          <div class="content">
              <div id="reportContent">
                  <div class="error">
                      <h2>Loading Report...</h2>
                      <p>Please wait while we load your financial data.</p>        
                  </div>
              </div>
          </div>
      </div>

      <script>
          function getUrlParameter(name) {
              name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
              var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
              var results = regex.exec(location.search);
              return results === null ? '' :
  decodeURIComponent(results[1].replace(/\+/g, ' '));
          }

          function formatCurrency(amount, currency = 'RM') {
              return `${currency} ${amount.toFixed(2)}`;
          }

          function createPieChart(canvasId, data, title) {
              const ctx = document.getElementById(canvasId).getContext('2d');      
              const labels = Object.keys(data);
              const values = Object.values(data);

              new Chart(ctx, {
                  type: 'pie',
                  data: {
                      labels: labels,
                      datasets: [{
                          data: values,
                          backgroundColor: [
                              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                              '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                          ]
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: {
                              position: 'bottom'
                          }
                      }
                  }
              });
          }

          function displayReport(reportData) {
              const currency = reportData.currency || 'RM';

              document.getElementById('reportPeriod').textContent =
                  `${reportData.type.charAt(0).toUpperCase() +
  reportData.type.slice(1)} Report - ${reportData.period}`;

              const content = `
                  <div class="summary-cards">
                      <div class="card income">
                          <h3>Total Income</h3>
                          <div
  class="amount">${formatCurrency(reportData.totalIncome, currency)}</div>
                      </div>
                      <div class="card expense">
                          <h3>Total Expenses</h3>
                          <div
  class="amount">${formatCurrency(reportData.totalExpenses, currency)}</div>       
                      </div>
                      <div class="card balance">
                          <h3>Net Balance</h3>
                          <div
  class="amount">${formatCurrency(reportData.netBalance, currency)}</div>
                      </div>
                      <div class="card">
                          <h3>Transactions</h3>
                          <div
  class="amount">${reportData.transactionCount}</div>
                      </div>
                  </div>

                  <div class="charts">
                      <div class="chart-container">
                          <h3 class="chart-title">Expenses by Category</h3>        
                          <canvas id="categoryChart"></canvas>
                      </div>
                      <div class="chart-container">
                          <h3 class="chart-title">Income vs Expenses</h3>
                          <canvas id="summaryChart"></canvas>
                      </div>
                  </div>
              `;

              document.getElementById('reportContent').innerHTML = content;        

              // Create charts
              setTimeout(() => {
                  if (Object.keys(reportData.categoryBreakdown).length > 0) {      
                      createPieChart('categoryChart',
  reportData.categoryBreakdown, 'Category Breakdown');
                  }

                  createPieChart('summaryChart', {
                      'Income': reportData.totalIncome,
                      'Expenses': reportData.totalExpenses
                  }, 'Income vs Expenses');
              }, 100);
          }

          // Main execution
          try {
              const encodedData = getUrlParameter('data');
              const userId = getUrlParameter('user');

              if (!encodedData) {
                  throw new Error('No report data found in URL');
              }

              // Decode the data
              const decodedData = atob(encodedData.replace(/-/g,
  '+').replace(/_/g, '/'));
              const reportData = JSON.parse(decodedData);

              displayReport(reportData);

          } catch (error) {
              document.getElementById('reportContent').innerHTML = `
                  <div class="error">
                      <h2>‚ùå Error Loading Report</h2>
                      <p>Unable to load the financial report data.</p>
                      <p><small>Error: ${error.message}</small></p>
                  </div>
              `;
          }
      </script>
  </body>
  </html>
